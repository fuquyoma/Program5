# Flask System Bonus 2000

Flask-приложение для управления уровнями бонусной программы пользователей с использованием JWT для аутентификации и возможности отслеживания транзакций.

## Функционал

- **Аутентификация**: Пользователи могут зарегистрироваться и войти в систему с помощью логина и пароля. После успешной авторизации выдается JWT-токен.
- **Уровни бонусов**: Система поддерживает уровни бонусной программы, которые автоматически обновляются на основе трат пользователя.
- **Транзакции**: Пользователь может добавлять транзакции, что инициирует проверку уровня бонусов.

## Настройка окружения

### 1. Переменные окружения
Создайте файл `.env` в корне проекта и добавьте следующие переменные:

```plaintext
DATABASE_URL=your_database_url
TESTING=True
SECRET_KEY=your_secret_key
```
### 2. Миграции базы данных
Применение миграций из папки migrations:
```cmd
goose postgres "postgresql://postgres:password@localhost:5432/postgres?sslmode=disable" up
```
## Маршруты API
## Аутентификация
### 1. Регистрация пользователя
POST /auth/register
Описание: Регистрирует нового пользователя с уровнем бонуса "Bronze" по умолчанию.
Пример запроса:
```json
{
  "username": "newuser",
  "password": "securepassword"
}
```
Пример ответа:
```json
{
  "token": "your_jwt_token_here",
  "user_id": 1
}
```
### 2. Логин пользователя
POST /auth/login
Описание: Аутентифицирует пользователя и выдает JWT-токен.
Пример запроса:
```json
{
  "username": "newuser",
  "password": "securepassword"
}
```
Пример ответа:
```json
{
  "token": "your_jwt_token_here"
}
```
## Уровни бонусов
### 3. Получение текущего бонусного уровня
GET /users/{id}/bonus
Описание: Возвращает информацию о текущем уровне бонусной программы для указанного пользователя.
Требует JWT-токен в заголовке.
Пример ответа:
```json
{
  "id": 1,
  "name": "Bronze",
  "min_spendings": 0,
  "cashback_percentage": 5
}
```
## Транзакции
### 4. Добавление новой транзакции
POST /users/{id}/transactions
Описание: Добавляет новую транзакцию и проверяет, нужно ли обновить уровень бонусов.
Требует JWT-токен в заголовке.
Пример запроса:
```json
{
  "amount": 600
}
```
Пример ответа:
```json
{
  "transaction_id": 5,
  "amount": 600,
  "new_spendings": 600,
  "bonus_update": "Bonus level updated"
}
```
## Запуск приложения через Docker
### 1. Сборка Docker-образа
```cmd
docker-compose build
```
### 2. Запуск контейнеров
```cmd
docker-compose up
```
Приложение будет доступно по адресу http://localhost:5000.

### 3. Остановка контейнеров
```cmd
docker-compose down
```
## Запуск тестов
```cmd
pytest tests/
```
## Запуск контейнеров с помощью Docker Compose
Для начала работы с проектом необходимо поднять контейнеры с помощью Docker Compose. Для этого выполните следующую команду:
```cmd
docker-compose up -d
```
docker-compose up -d запускает все контейнеры в фоновом режиме. Убедитесь, что у вас правильно настроены образы для PostgreSQL и другие сервисы.

## Проверка состояния контейнеров
Для проверки того, что контейнеры запущены и работают корректно, используйте команду:
```cmd
docker ps
```
## Применение миграций базы данных
Для обновления схемы базы данных в соответствии с моделями, выполните миграции:

### 1. Создание миграций
```cmd
flask db migrate -m "Initial migration"
```
### 2. Применение миграций
```cmd
flask db upgrade
```
## Запуск приложения
Запуск приложения:
```cmd
flask run
```
Это запустит сервер Flask на http://127.0.0.1:5000.

## Проверка работы API
Для проверки работы API, например, отправьте запрос:

POST /auth/login — для получения JWT токена.
GET /users/{id}/bonus — для получения текущего бонусного уровня пользователя.
POST /users/{id}/transactions — для добавления транзакции пользователя.
## Остановка контейнеров
Когда работа с приложением завершена, остановите контейнеры:
```cmd
docker-compose down
```
